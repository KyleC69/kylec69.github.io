{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Workflow",
  "type": "object",
  "required": ["WorkflowName", "Rules"],
  "properties": {
    "$schema": { "type": "string" },
    "WorkflowName": { "type": "string" },
    "SchemaVersion": { "type": "string" },
    "Author": { "type": "string" },
    "CreatedOn": { "type": "string", "format": "date-time" },

    "Applicability": {
      "type": "object",
      "properties": {
        "OSFamily": { "type": "string" },
        "MinVersion": { "type": "string" },
        "MaxVersion": { "type": "string" },
        "Product": { "type": "string" }
      }
    },

    "Constraints": {
      "type": "object",
      "properties": {
        "RunSequentially": { "type": "boolean" },
        "StopOnFailure": { "type": "boolean" },
        "Timeout": {
          "type": "string",
          "pattern": "^[0-9]{2}:[0-9]{2}:[0-9]{2}$"
        }
      }
    },

    "Rules": {
      "type": "array",
      "items": { "$ref": "#/definitions/Rule" }
    },

    "Results": {
      "type": "array",
      "items": { "$ref": "#/definitions/Result" }
    }
  },

  "definitions": {
    "Rule": {
      "type": "object",
      "required": ["RuleName", "Provider", "Parameters", "Condition"],
      "properties": {
        "RuleName": { "type": "string" },
        "Provider": {
          "type": "string",
          "enum": [
            "Registry",
            "FileSystem",
            "ACL",
            "WMI",
            "EventLog",
            "Service",
            "Process",
            "Custom"
          ]
        },
        "Parameters": {
          "oneOf": [
            { "$ref": "#/definitions/RegistryParameters" },
            { "$ref": "#/definitions/FileSystemParameters" },
            { "$ref": "#/definitions/AclParameters" },
            { "$ref": "#/definitions/WmiParameters" },
            { "$ref": "#/definitions/EventLogParameters" },
            { "$ref": "#/definitions/ServiceParameters" },
            { "$ref": "#/definitions/ProcessParameters" },
            { "$ref": "#/definitions/CustomParameters" }
          ]
        },
        "Condition": { "$ref": "#/definitions/Condition" },
        "Severity": { "type": "integer", "minimum": 0, "maximum": 10 },
        "Message": { "type": "string" },
        "Tags": {
          "type": "array",
          "items": { "type": "string" }
        },
        "Execution": { "$ref": "#/definitions/ExecutionOptions" }
      }
    },

    "RegistryParameters": {
      "type": "object",
      "required": ["Hive", "Path", "Key"],
      "properties": {
        "Hive": { "type": "string" },
        "Path": { "type": "string" },
        "Key": { "type": "string" }
      },
      "additionalProperties": false
    },

    "FileSystemParameters": {
      "type": "object",
      "required": ["Path"],
      "properties": {
        "Path": { "type": "string" },
        "Permissions": { "type": "string" },
        "Recursive": { "type": "boolean" }
      },
      "additionalProperties": false
    },

    "AclParameters": {
      "type": "object",
      "required": ["Path", "Identity", "Rights"],
      "properties": {
        "Path": { "type": "string" },
        "Identity": { "type": "string" },
        "Rights": { "type": "string" }
      },
      "additionalProperties": false
    },

    "WmiParameters": {
      "type": "object",
      "required": ["Namespace", "Class", "Property"],
      "properties": {
        "Namespace": { "type": "string" },
        "Class": { "type": "string" },
        "Property": { "type": "string" }
      },
      "additionalProperties": false
    },

    "EventLogParameters": {
      "type": "object",
      "required": ["LogName"],
      "properties": {
        "LogName": { "type": "string" },
        "Source": { "type": "string" },
        "EventId": { "type": "integer" },
        "Since": { "type": "string", "format": "date-time" }
      },
      "additionalProperties": false
    },

    "ServiceParameters": {
      "type": "object",
      "required": ["ServiceName"],
      "properties": {
        "ServiceName": { "type": "string" },
        "ExpectedStatus": {
          "type": "string",
          "enum": ["Running", "Stopped", "Disabled"]
        }
      },
      "additionalProperties": false
    },

    "ProcessParameters": {
      "type": "object",
      "required": ["ProcessName"],
      "properties": {
        "ProcessName": { "type": "string" },
        "ExpectedCount": { "type": "integer" }
      },
      "additionalProperties": false
    },

    "CustomParameters": {
      "type": "object",
      "properties": {
        "Values": {
          "type": "object",
          "additionalProperties": true
        }
      }
    },

    "Condition": {
      "type": "object",
      "required": ["Operator", "Expected"],
      "properties": {
        "Operator": {
          "type": "string",
          "enum": [
            "Equals",
            "NotEquals",
            "GreaterThan",
            "LessThan",
            "Contains",
            "NotContains",
            "RegexMatch",
            "Exists",
            "NotExists"
          ]
        },
        "Expected": {
          "type": [
            "string",
            "number",
            "boolean",
            "array",
            "object",
            "null"
          ]
        }
      }
    },

    "ExecutionOptions": {
      "type": "object",
      "properties": {
        "RunMode": {
          "type": "string",
          "enum": ["Independent", "Sequential"],
          "default": "Independent"
        },
        "Timeout": {
          "type": "string",
          "pattern": "^[0-9]{2}:[0-9]{2}:[0-9]{2}$"
        },
        "StopOnFailure": { "type": "boolean", "default": false },
        "DependsOn": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },

    "Result": {
      "type": "object",
      "properties": {
        "RuleName": { "type": "string" },
        "Success": { "type": "boolean" },
        "Message": { "type": "string" },
        "SeverityScore": { "type": "integer" },
        "Timestamp": { "type": "string", "format": "date-time" },
        "SchemaVersion": { "type": "string" },
        "ExecutionMode": {
          "type": "string",
          "enum": ["Independent", "Sequential"]
        }
      }
    }
  }
}